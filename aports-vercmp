#!/usr/bin/lua5.2



archlinux = require("upstream.archlinux").Init()
gnome = require("upstream.gnome")

maintainer = {}

io.stderr:write("Reading aports...\n")
db = require("aports.db").new("~/aports", "main")

for p in db:each_aport() do
	local gname = gnome.is_gnome_source(p)
	if gname then
		newver = gnome.find_newer(gname, p.pkgver)
		upstream = "gnome"
	else
		newver = archlinux:find_newer(p.pkgname, p.pkgver)
		upstream = "archlinux"
	end
	if newver ~= nil then
		local m = p:get_maintainer()
		local t = {
			["name"] = p.pkgname,
			["current"] = p.pkgver,
			["new"] = newver,
			["upstream"] = upstream,
			}
		if maintainer[m] == nil then
			maintainer[m] = {}
		end
		table.insert(maintainer[m], t)
	end
end

print(os.date())
for m, pkgs in pairs(maintainer) do
	if m == nil or m == "" then
		m = "(unmaintained)"
	end
	table.sort(pkgs, function(a,b) return a.name<b.name end)
	print("==== "..m.." ====")
	for i,p in pairs(pkgs) do
		print(string.format("%-40s(current: %s) %s",
				    p.name.."-"..p.new, p.current, p.upstream))
	end
	print()
end
